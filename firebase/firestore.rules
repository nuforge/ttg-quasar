rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Events collection
    match /events/{eventId} {
      // Anyone can read events
      allow read: if true;
      
      // Authenticated users can create events, admins can create any event
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.createdBy ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com']
      );
      
      // Event creator or admins can update/delete
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com']
      );
    }
    
    // Messages collection
    match /messages/{messageId} {
      // Users can read messages they're involved in
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.recipients ||
        request.auth.uid == resource.data.sender ||
        resource.data.type in ['game', 'event'] // Public comments
      );
      
      // Only authenticated users can create messages
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.sender;
      
      // Users can only update/delete their own messages
      allow update, delete: if request.auth != null &&
        request.auth.uid == resource.data.sender;
    }
    
    // Players collection
    match /players/{playerId} {
      // Anyone can read player profiles (for public info)
      allow read: if true;
      
      // Users can create/update their own profile, admins can create/update any profile
      allow create, update: if request.auth != null && (
        request.auth.uid == playerId ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com']
      );
      
      // Prevent deletion of player profiles (except by admins)
      allow delete: if request.auth != null &&
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com'];
    }
    
    // Friendships collection (for future use)
    match /friendships/{friendshipId} {
      allow read, write: if request.auth != null && (
        request.auth.uid == resource.data.requesterId ||
        request.auth.uid == resource.data.receiverId
      );
    }

    // Games collection
    match /games/{gameId} {
      // Anyone can read games
      allow read: if true;
      
      // Only admins can create, update, or delete games
      // For testing: temporarily allow any authenticated user during development
      allow create, update, delete: if request.auth != null;
      // Production: use email allowlist instead:
      // allow create, update, delete: if request.auth != null &&
      //   request.auth.token.email in ['admin@ttgaming.com', 'your-email@example.com'];
    }

    // Game submissions collection (for user-submitted games pending approval)
    match /gameSubmissions/{submissionId} {
      // Users can read their own submissions, admins can read all
      // For testing: allow any authenticated user
      allow read: if request.auth != null;
      // Production: restrict to submitter and admins:
      // allow read: if request.auth != null && (
      //   request.auth.uid == resource.data.submittedBy.userId ||
      //   request.auth.token.email in ['admin@ttgaming.com', 'your-email@example.com']
      // );
      
      // Only authenticated users can create submissions
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.submittedBy.userId &&
        request.resource.data.status == 'pending';
      
      // For testing: allow any authenticated user to update
      allow update: if request.auth != null;
      // Production: only admins:
      // allow update: if request.auth != null &&
      //   request.auth.token.email in ['admin@ttgaming.com', 'your-email@example.com'];
      
      // Only the submitter can delete their own pending submissions
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.submittedBy.userId &&
        resource.data.status == 'pending';
    }

    // Event submissions collection
    match /eventSubmissions/{submissionId} {
      // Users can read their own submissions, admins can read all
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.submittedBy.userId ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@example.com'] // Add your admin emails here
      );
      
      // Only authenticated users can create submissions
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.submittedBy.userId &&
        request.resource.data.status == 'pending';
      
      // Only admins can update submissions (for approval/rejection)
      allow update: if request.auth != null &&
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@example.com']; // Add your admin emails here
      
      // Only the submitter can delete their own pending submissions
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.submittedBy.userId &&
        resource.data.status == 'pending';
    }

    // User roles collection (for role-based access control)
    match /userRoles/{userId} {
      // Users can read their own role, admins can read all roles
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com']
      );
      
      // Only admins can create, update, or delete user roles
      allow create, update, delete: if request.auth != null &&
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com'];
    }

    // User statuses collection (for user status tracking)
    match /userStatuses/{userId} {
      // Users can read their own status, admins can read all statuses
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com']
      );
      
      // Only admins can create, update, or delete user statuses
      allow create, update, delete: if request.auth != null &&
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com'];
    }

    // User preferences collection (for game favorites, bookmarks, notifications)
    match /userPreferences/{userId} {
      // Users can only read and modify their own preferences
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Game ownerships collection (for tracking which games players own and can bring)
    match /gameOwnerships/{ownershipId} {
      // Users can read their own ownerships, anyone can read to see who owns games
      allow read: if true; // Allow anyone to see game ownership for event planning
      
      // Users can only create/update/delete their own ownerships
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.playerId;
      
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.playerId;
      
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.playerId;
    }

    // Game event notifications collection
    match /gameEventNotifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Users can update their own notifications (to mark as read)
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        // Only allow updating read status and updatedAt
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'updatedAt']);
      
      // Only the system/admins can create notifications
      allow create: if request.auth != null &&
        request.auth.token.email in ['admin@ttgaming.com', 'nuforge@gmail.com'];
      
      // Users can delete their own notifications
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}
